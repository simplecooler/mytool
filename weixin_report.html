<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>数据报表</title>
    <link href="/static/bootstrap-3.3.2/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/animate.css" rel="stylesheet" type="text/css">
</head>
<style>
    .page {
        width: 100%;
        height: 100%;
        text-align: center;
    }

    .content {
        padding:10px;
    }

    .title {
        width:80%;
        margin: 0 auto;
        padding:3px 0;
        background-color: #6673FE;
        border-radius: 5px;
        color: #FFFFFF;
        font-weight: bold;
    }

    .table {
        margin-bottom: 0;
    }

    .total_table {
        margin-top: 20px;
        border-radius: 5px;
    }

    .top_table {
        margin-top: 20px;
    }

    .top_ddos_table {
        margin-top: 10px;
        margin-bottom: 20px;
    }

    .pie-chart {
        height: 230px;
        width: 100%;
        margin-top: 10px;
    }

    .pie-font {
        font-size: 12px;
    }

    .foot_button {
        position: fixed;
        bottom: 0;
    }

    .foot_button td {
        background-color: #ffffff;
    }

    .table>tbody>tr>td {
        vertical-align: middle;
    }

    .select-block {
        position: fixed;
        left:1px;
        width: 100%;
    }

    .select-table {
        width: 25%;
        display: none;
        animation-duration: 0.5s;
    }

    .select-table td {
        background-color: #ffffff;
    }

    .foot_btn {
        font-size: 13px;
    }
</style>
<body>
<div class="page">
    <!--内容-->
    <div class="content" id="content_render"></div>
    <!--按钮弹出-->
    <div class="container-fluid select-block">
        <div class="row">
            <table class="table table-bordered col-xs-3 select-table animated slideInUp" id="access">
                <tbody>
                <tr><td action="btn_today">今天</td></tr>
                <tr><td action="btn_yesterday">昨天</td></tr>
                <tr><td action="btn_seven">7天</td></tr>
                </tbody>
            </table>

            <table class="table table-bordered col-xs-3 col-xs-offset-3 select-table animated slideInUp" id="safe">
                <tbody>
                <tr><td action="btn_today">今天</td></tr>
                <tr><td action="btn_yesterday">昨天</td></tr>
                <tr><td action="btn_seven">7天</td></tr>
                </tbody>
            </table>

            <table class="table table-bordered col-xs-3 col-xs-offset-6 select-table animated slideInUp" id="speed">
                <tbody>
                <tr><td action="btn_today">今天</td></tr>
                <tr><td action="btn_yesterday">昨天</td></tr>
                <tr><td action="btn_seven">7天</td></tr>
                </tbody>
            </table>

            <table class="table table-bordered col-xs-3 col-xs-offset-9 select-table animated slideInUp" id="ddos">
                <tbody>
                <tr><td action="btn_today">今天</td></tr>
                <tr><td action="btn_yesterday">昨天</td></tr>
                <tr><td action="btn_seven">7天</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <!--底部按钮-->
    <table class="table table-bordered foot_button">
        <tbody>
        <tr>
            <td class="foot_btn col-xs-3" id="access_btn"><span class="glyphicon glyphicon-chevron-up"></span><br/>访问情况</td>
            <td class="foot_btn col-xs-3" id="safe_btn"><span class="glyphicon glyphicon-chevron-up"></span><br/>安全情况</td>
            <td class="foot_btn col-xs-3" id="speed_btn"><span class="glyphicon glyphicon-chevron-up"></span><br/>加速情况</td>
            <td class="foot_btn col-xs-3" id="ddos_btn"><span class="glyphicon glyphicon-chevron-up"></span><br/>DDoS攻击</td>
        </tr>
        </tbody>
    </table>
</div>
</body>
<!--访问情况模板-->
<script type="text/template" id="access_template">
    <div class="title">{{title}}</div>
    <table class="table table-bordered total_table">
        <thead>
        <tr>
            <td class="col-xs-6">总请求次数</td>
            <td class="col-xs-6">总流量</td>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="col-xs-6">{{total_req_count}} 次</td>
            <td class="col-xs-6">{{total_req_flow}} MB</td>
        </tr>
        </tbody>
    </table>

    <table class="table table-bordered top_table">
        <thead>
        <tr>
            <td class="col-xs-4">访问IP前五</td>
            <td class="col-xs-4">归属地</td>
            <td class="col-xs-4">次数</td>
        </tr>
        </thead>
        <tbody>
        {{#top5_arr}}
        <tr>
            <td>{{ip}}</td>
            <td>{{location}}</td>
            <td>{{count}} 次</td>
        </tr>
        {{/top5_arr}}
        </tbody>
    </table>
</script>
<!--安全情况模板-->
<script type="text/template" id="safe_template">
    <div class="title">{{title}}</div>
    <table class="table table-bordered total_table">
        <thead>
        <tr>
            <td class="col-xs-6">CC攻击总数</td>
            <td class="col-xs-6">WAF攻击总数</td>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="col-xs-6">{{total_cc_count}} 次</td>
            <td class="col-xs-6">{{total_waf_count}} 次</td>
        </tr>
        </tbody>
    </table>

    <table class="table table-bordered top_table">
        <thead>
        <tr>
            <td class="col-xs-4">CC攻击IP前五</td>
            <td class="col-xs-4">归属地</td>
            <td class="col-xs-4">次数</td>
        </tr>
        </thead>
        <tbody>
        {{#top5_cc_arr}}
        <tr>
            <td>{{ip}}</td>
            <td>{{location}}</td>
            <td>{{count}} 次</td>
        </tr>
        {{/top5_cc_arr}}
        </tbody>
    </table>

    <table class="table table-bordered top_table">
        <thead>
        <tr>
            <td class="col-xs-4">WAF攻击IP前五</td>
            <td class="col-xs-4">归属地</td>
            <td class="col-xs-4">次数</td>
        </tr>
        </thead>
        <tbody>
        {{#top5_waf_arr}}
        <tr>
            <td>{{ip}}</td>
            <td>{{location}}</td>
            <td>{{count}} 次</td>
        </tr>
        {{/top5_waf_arr}}
        </tbody>
    </table>
</script>
<!--加速情况模板-->
<script type="text/template" id="speed_template">
    <div class="title">{{title}}</div>
    <div class="pie-chart" id="pie_chart_flow"></div>
    <p class="pie-font">总流量：{{total_flow}} MB 缓存流量：{{save_flow}} MB 加速比例：{{percent_flow}} %</p>
    <div class="pie-chart" id="pie_chart_req"></div>
    <p class="pie-font">总请求：{{total_req}} 次 缓存请求：{{save_req}} MB 加速比例：{{percent_req}} %</p>
</script>
<!--DDoS攻击模板-->
<script type="text/template" id="ddos_template">
    <div class="title">{{title}}</div>
    <table class="table table-bordered top_ddos_table top_table">
        <thead>
        <tr>
            <td class="col-xs-6">带宽峰值</td>
            <td class="col-xs-6">时间</td>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="col-xs-6">{{top_flow}} G</td>
            <td class="col-xs-6">{{time}}</td>
        </tr>
        </tbody>
    </table>

    <table class="table table-bordered top_ddos_table">
        <thead>
        <tr>攻击类型前六</tr>
        </thead>
        <tbody>
        {{#top6_type}}
        <tr>
            <td>{{one}}</td>
            <td>{{two}}</td>
            <td>{{three}} 次</td>
        </tr>
        {{/top6_type}}
        </tbody>
    </table>

    <table class="table table-bordered top_ddos_table">
        <thead>
        <tr>攻击IP前十</tr>
        </thead>
        <tbody>
        {{#top10_ip}}
        <tr>
            <td>{{first}}</td>
            <td>{{second}}</td>
        </tr>
        {{/top10_ip}}
        </tbody>
    </table>
</script>

<script src="/static/js/jquery/jquery-2.1.4.min.js"></script>
<script src="/static/js/mustache.js" type="text/javascript"></script>
<script src="/static/echarts-2.2.4/dist/echarts.js" type="text/javascript"></script>
<script>
    //参考数据

    var safe_today = {
        title: "今天安全情况",
        total_cc_count: 100000,
        total_waf_count: 212000,
        top5_cc_arr: [
            {ip: "192.168.3.3", location: "上海", count: 323},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212}
        ],
        top5_waf_arr: [
            {ip: "192.168.3.3", location: "上海", count: 323},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212}
        ]
    };

    var safe_yesterday = {
        title: "昨天安全情况",
        total_cc_count: 100000,
        total_waf_count: 212000,
        top5_cc_arr: [
            {ip: "192.168.3.3", location: "上海", count: 323},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212}
        ],
        top5_waf_arr: [
            {ip: "192.168.3.3", location: "上海", count: 323},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212}
        ]
    };

    var safe_seven = {
        title: "7天安全情况",
        total_cc_count: 100000,
        total_waf_count: 212000,
        top5_cc_arr: [
            {ip: "192.168.3.3", location: "上海", count: 323},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212}
        ],
        top5_waf_arr: [
            {ip: "192.168.3.3", location: "上海", count: 323},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212},
            {ip: "192.168.3.22", location: "上海", count: 212}
        ]
    };

    var speed_today = {
        title: "今天加速情况",
        total_flow: 10000,
        save_flow: 310,
        percent_flow: 52,
        total_req: 10000,
        save_req: 310,
        percent_req: 52
    };

    var speed_yesterday = {
        title: "昨天加速情况",
        total_flow: 10000,
        save_flow: 310,
        percent_flow: 52,
        total_req: 10000,
        save_req: 310,
        percent_req: 52
    };

    var speed_seven = {
        title: "7天加速情况",
        total_flow: 10000,
        save_flow: 310,
        percent_flow: 52,
        total_req: 10000,
        save_req: 310,
        percent_req: 52
    };

    var ddos_today = {
        title: "今天DDoS攻击情况",
        top_flow: 100,
        time: "11:59:23",
        top6_type: [
            {one: "ACK", two: "UDP flood", three: "ICMP"},
            {one: "ACK", two: "UDP flood", three: "ICMP"}
        ],
        top10_ip: [
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"}
        ]
    };

    var ddos_yesterday = {
        title: "昨天DDoS攻击情况",
        top_flow: 100,
        time: "11:59:23",
        top6_type: [
            {one: "ACK", two: "UDP flood", three: "ICMP"},
            {one: "ACK", two: "UDP flood", three: "ICMP"}
        ],
        top10_ip: [
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"}
        ]
    };

    var ddos_seven = {
        title: "7天DDoS攻击情况",
        top_flow: 100,
        time: "11:59:23",
        top6_type: [
            {one: "ACK", two: "UDP flood", three: "ICMP"},
            {one: "ACK", two: "UDP flood", three: "ICMP"}
        ],
        top10_ip: [
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"},
            {first: "192.168.3.3(上海)", second: "192.168.3.3(上海)"}
        ]
    };

    $(document).ready(function(){

        //得到域名列表传入的域名
        function GetQueryString(name)
        {
            var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if(r!=null)return  unescape(r[2]); return null;
        }
        var domain = GetQueryString("domain");

        var userid = GetQueryString("userID");

        var id = GetQueryString("id");


        //页面初始定位
        $('.foot_button td').css('height',window.innerHeight * 0.08);
        $('.select-block').css('bottom',$('.foot_button').height());
        $('.page').css('padding-bottom',$('.foot_button').height() + 13);

        //按钮方法调用
        btn_show('#access','#safe','#speed','#ddos');
        btn_show('#safe','#access','#speed','#ddos');
        btn_show('#speed','#safe','#access','#ddos');
        btn_show('#ddos','#safe','#speed','#access');

        //点击按钮其他地方弹出窗口消失
        $(document).on('click',function(){
            $('#access').css('display','none');
            $('#safe').css('display','none');
            $('#speed').css('display','none');
            $('#ddos').css('display','none');
        });

        //进入页面立即渲染今日访问报表
//        $('#content_render').html(Mustache.to_html($('#access_template').html(), access_today));


        //访问情况接口调用和模板渲染
        $('#access td').on('click',function(e){
            var current = $(e.currentTarget);
            if(current.attr("action") === "btn_today") {
                $.ajax({
                    type:"POST",
                    data:{domain:domain,node:"",size:5,start_time:getTime('end'),end_time:getTime('now')},
                    url:'/weixin/mobile/ngAccessWX',
                    dataType:'json',
                    success:function(data){
                        var today_data = {
                            title: "今天访问概述",
                            total_req_count:data.data.sum_times,
                            total_req_flow:data.data.sum_flaw,
                            top5_arr:data.data.ip_lists
                        };
                        var rendered = Mustache.to_html($('#access_template').html(), today_data);
                        $('#content_render').html(rendered);
                    }
                });
            }else if(current.attr("action") === "btn_yesterday") {
                $.ajax({
                    type:"POST",
                    data:{domain:domain,node:"",size:5,start_time:getTime('yesterday'),end_time:getTime('end')},
                    url:'/weixin/mobile/ngAccessWX',
                    dataType:'json',
                    success:function(data){
                        var yesterday_data = {
                            title: "昨天访问概述",
                            total_req_count:data.data.sum_times,
                            total_req_flow:data.data.sum_flaw,
                            top5_arr:data.data.ip_lists
                        };
                        var rendered = Mustache.to_html($('#access_template').html(), yesterday_data);
                        $('#content_render').html(rendered);
                    }
                });
            }else if(current.attr("action") === "btn_seven") {
                $.ajax({
                    type:"POST",
                    data:{domain:domain,node:"",size:5,start_time:getTime('sevenStart'),end_time:getTime('now')},
                    url:'/weixin/mobile/ngAccessWX',
                    dataType:'json',
                    success:function(data){
                        var seven_data = {
                            title: "昨天访问概述",
                            total_req_count:data.data.sum_times,
                            total_req_flow:data.data.sum_flaw,
                            top5_arr:data.data.ip_lists
                        };
                        var rendered = Mustache.to_html($('#access_template').html(), seven_data);
                        $('#content_render').html(rendered);
                    }
                });
            }
        });

        //安全情况接口调用和模板渲染
        $('#safe td').on('click',function(e){
            var current = $(e.currentTarget);
            if(current.attr("action") === "btn_today") {
                $.ajax({
                    type:"POST",
                    data:{userID:userid,l:"reportsummary",days:1,t:"ccline"},
                    url:'/dashboard/report/'+ id,
                    dataType:'json',
                    success:function(data){
//                        var today_data = {
//                            title: "今天访问概述",
//                            total_req_count:data.data.sum_times,
//                            total_req_flow:data.data.sum_flaw,
//                            top5_arr:data.data.ip_lists
//                        };
//                        var rendered = Mustache.to_html($('#access_template').html(), today_data);
//                        $('#content_render').html(rendered);
//                        alert(JSON.stringify(data));
                    }
                });

            }
        });

        //模板渲染方法调用
        template_render('#safe','#safe_template','#content_render',safe_today,safe_yesterday,safe_seven);
        template_render('#speed','#speed_template','#content_render',speed_today,speed_yesterday,speed_seven, function () {
            charts_show('pie_chart_flow','pie_chart_flow','pie_chart_flow_option','回源请求',310,'加速请求',335);
            charts_show('pie_chart_req','pie_chart_req','pie_chart_req_option','回源请求',310,'加速请求',335);
        });
        template_render('#ddos','#ddos_template','#content_render',ddos_today,ddos_yesterday,ddos_seven);
    });

    //按钮方法
    var btn_show = function(dom_id,first_dom,second_dom,third_dom){
        $(dom_id + '_btn').on('click',function(e){
            var status = $(dom_id).css('display');
            if(status === 'none'){
                $(first_dom).css('display','none');
                $(second_dom).css('display','none');
                $(third_dom).css('display','none');
                $(dom_id).css('display','table');
                status = 'table';
            }else{
                $(dom_id).css('display','none');
                status = 'none';
            }
            e.stopPropagation();
        });
    };

    //模板渲染方法
    var template_render = function (dom_id,template_id,render_id,today_data,yesterday_data,seven_data,callback) {
        $(dom_id + ' td').on('click',function(e){
            var current = $(e.currentTarget);
            if(current.attr("action") === "btn_today") {
                var rendered = Mustache.to_html($(template_id).html(), today_data);
                $(render_id).html(rendered);
            }else if(current.attr("action") === "btn_yesterday") {
                var rendered = Mustache.to_html($(template_id).html(), yesterday_data);
                $(render_id).html(rendered);
            }else if(current.attr("action") === "btn_seven") {
                var rendered = Mustache.to_html($(template_id).html(), seven_data);
                $(render_id).html(rendered);
            }
            if ($.isFunction(callback)) {
                callback();
            }
        });
    };

    //得到时间方法
    var getTime = function getNowFormatDate(day) {
        if(day === 'now') {
            var n_date = new Date();
            var n_month = n_date.getMonth() + 1;
            var n_day = n_date.getDate();
            var n_hour = n_date.getHours();
            var n_minute = n_date.getMinutes();
            var n_seconds = n_date.getSeconds();
            if (n_month >= 1 && n_month <= 9) {
                n_month = "0" + n_month;
            }
            if (n_day >= 0 && n_day <= 9) {
                n_day = "0" + n_day;
            }
            if (n_hour >= 0 && n_hour <= 9) {
                n_hour = "0" + n_hour;
            }
            if (n_minute >= 0 && n_minute <= 9) {
                n_minute = "0" + n_minute;
            }
            if (n_seconds >= 0 && n_seconds <= 9) {
                n_seconds = "0" + n_seconds;
            }
            var n_time = n_date.getFullYear() + "-" + n_month + "-" + n_day + " " + n_hour + ":" + n_minute + ":" + n_seconds;
            return n_time;

        }else if(day === 'sevenStart') {
            var s_now = new Date();
            var s_date = new Date(s_now.getTime() - 7 * 24 * 3600 * 1000);
            var s_month = s_date.getMonth() + 1;
            var s_day = s_date.getDate();
            if (s_month >= 1 && s_month <= 9) {
                s_month = "0" + s_month;
            }
            if (s_day >= 0 && s_day <= 9) {
                s_day = "0" + s_day;
            }
            var s_time = s_date.getFullYear() + '-' + s_month + '-' + s_day  + ' ' + '00:00:00';
            return s_time;

        }else if(day === 'yesterday') {
            var y_now = new Date();
            var y_date = new Date(y_now.getTime() - 1 * 24 * 3600 * 1000);
            var y_month = y_date.getMonth() + 1;
            var y_day = y_date.getDate();
            if (y_month >= 1 && y_month <= 9) {
                y_month = "0" + y_month;
            }
            if (y_day >= 0 && y_day <= 9) {
                y_day = "0" + y_day;
            }
            var y_time = y_date.getFullYear() + '-' + y_month + '-' + y_day  + ' ' + '00:00:00';
            return y_time;

        }else if(day === 'end') {
            var e_date = new Date();
            var e_month = e_date.getMonth() + 1;
            var e_day = e_date.getDate();
            if (e_month >= 1 && e_month <= 9) {
                e_month = "0" + e_month;
            }
            if (e_day >= 0 && e_day <= 9) {
                e_day = "0" + e_day;
            }
            var e_time = e_date.getFullYear() + '-' + e_month + '-' + e_day  + ' ' + '00:00:00';
            return e_time;

        }
    };

    //图表渲染方法
    var charts_show = function (dom_id,chart_name,chart_name_option,data_name_first,data_first,data_name_second,data_second) {
        require.config({
            paths: {
                echarts: '/static/echarts-2.2.4/dist'
            }
        });
        require(
                [
                    'echarts',
                    'echarts/chart/pie'
                ],
                function (ec) {
                    var chart_name = ec.init(document.getElementById(dom_id));
                    var chart_name_option = {
                        tooltip : {
                            trigger: 'item',
                            formatter: "{a} <br/>{b} : {c} ({d}%)"
                        },
                        legend: {
                            orient : 'horizontal',
                            x : 'center',
                            data:[data_name_first,data_name_second]
                        },
                        calculable : true,
                        series : [
                            {
                                name:'加速情况',
                                type:'pie',
                                radius : ['50%', '70%'],
                                itemStyle : {
                                    normal : {
                                        label : {
                                            show : false
                                        },
                                        labelLine : {
                                            show : false
                                        }
                                    },
                                    emphasis : {
                                        label : {
                                            show : true,
                                            position : 'center',
                                            textStyle : {
                                                fontSize : '30',
                                                fontWeight : 'bold'
                                            }
                                        }
                                    }
                                },
                                data:[
                                    {value:data_second, name:data_name_second},
                                    {value:data_first, name:data_name_first}
                                ]
                            }
                        ]
                    };
                    chart_name.setOption(chart_name_option);
                }
        );
    };

</script>
</html>